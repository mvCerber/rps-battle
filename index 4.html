
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>RPS Battle</title>
  <style>
    body {
      font-family: sans-serif;
      background: #0e0e0e;
      color: #fff;
      padding: 20px;
      max-width: 600px;
      margin: auto;
    }
    h1 { text-align: center; }
    button {
      background: #00cc99;
      color: white;
      padding: 10px;
      margin: 5px 0;
      border: none;
      border-radius: 5px;
      cursor: pointer;
      width: 100%;
    }
    button:disabled {
      background: #444;
      cursor: not-allowed;
    }
    input {
      width: 100%;
      padding: 8px;
      margin: 5px 0 10px;
      border-radius: 4px;
      border: none;
    }
    .status, .log, .section {
      margin: 15px 0;
      padding: 10px;
      background: #1e1e1e;
      border-radius: 6px;
    }
    @media (max-width: 500px) {
      body {
        padding: 10px;
      }
    }
  </style>
</head>
<body>
  <h1>Rock Paper Scissors Battle</h1>

  <div class="status">
    <b>Game Status:</b> <span id="gameState">Loading...</span><br/>
    <b>Player 1:</b> <span id="player1">-</span><br/>
    <b>Player 2:</b> <span id="player2">-</span><br/>
    <b>Winner:</b> <span id="winner">-</span>
  </div>

  <div class="section">
    <button id="connectBtn">Connect Wallet</button>
    <button id="joinAsPlayer1">Join as Player 1</button>
    <button id="joinAsPlayer2">Join as Player 2</button>
  </div>

  <div class="section">
    <input id="moveInput" placeholder="Enter move: rock/paper/scissors"/>
    <input id="secretInput" placeholder="Enter secret"/>
    <button id="commitBtn">Commit Move</button>
    <button id="revealBtn">Reveal Move</button>
  </div>

  <div class="section">
    <button id="resetBtn">New Duel</button>
  </div>

  <div class="log">
    <b>Log:</b>
    <pre id="logOutput">Waiting for interaction...</pre>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/ethers@5.7.2/dist/ethers.umd.min.js"></script>
  <script>
    const contractAddress = '0x82CC8cDF9f152cA4dF361d2741a5B698445bAe80';
    const abi = [
    {
        "inputs": [
            {
                "internalType": "bytes32",
                "name": "moveHash",
                "type": "bytes32"
            }
        ],
        "name": "commitMove",
        "outputs": [],
        "stateMutability": "nonpayable",
        "type": "function"
    },
    {
        "inputs": [],
        "name": "joinAsPlayer1",
        "outputs": [],
        "stateMutability": "payable",
        "type": "function"
    },
    {
        "inputs": [],
        "name": "joinAsPlayer2",
        "outputs": [],
        "stateMutability": "payable",
        "type": "function"
    },
    {
        "inputs": [],
        "name": "resetGame",
        "outputs": [],
        "stateMutability": "nonpayable",
        "type": "function"
    },
    {
        "inputs": [
            {
                "internalType": "string",
                "name": "moveStr",
                "type": "string"
            },
            {
                "internalType": "string",
                "name": "secret",
                "type": "string"
            }
        ],
        "name": "revealMove",
        "outputs": [],
        "stateMutability": "nonpayable",
        "type": "function"
    },
    {
        "inputs": [
            {
                "internalType": "address",
                "name": "_devWallet",
                "type": "address"
            }
        ],
        "stateMutability": "nonpayable",
        "type": "constructor"
    },
    {
        "inputs": [
            {
                "internalType": "address",
                "name": "",
                "type": "address"
            }
        ],
        "name": "committedMove",
        "outputs": [
            {
                "internalType": "bytes32",
                "name": "",
                "type": "bytes32"
            }
        ],
        "stateMutability": "view",
        "type": "function"
    },
    {
        "inputs": [],
        "name": "devWallet",
        "outputs": [
            {
                "internalType": "address",
                "name": "",
                "type": "address"
            }
        ],
        "stateMutability": "view",
        "type": "function"
    },
    {
        "inputs": [],
        "name": "gameState",
        "outputs": [
            {
                "internalType": "enum RockPaperScissorsBattleSafe.GameState",
                "name": "",
                "type": "uint8"
            }
        ],
        "stateMutability": "view",
        "type": "function"
    },
    {
        "inputs": [],
        "name": "player1",
        "outputs": [
            {
                "internalType": "address",
                "name": "",
                "type": "address"
            }
        ],
        "stateMutability": "view",
        "type": "function"
    },
    {
        "inputs": [],
        "name": "player2",
        "outputs": [
            {
                "internalType": "address",
                "name": "",
                "type": "address"
            }
        ],
        "stateMutability": "view",
        "type": "function"
    },
    {
        "inputs": [
            {
                "internalType": "address",
                "name": "",
                "type": "address"
            }
        ],
        "name": "revealedMove",
        "outputs": [
            {
                "internalType": "enum RockPaperScissorsBattleSafe.Move",
                "name": "",
                "type": "uint8"
            }
        ],
        "stateMutability": "view",
        "type": "function"
    },
    {
        "inputs": [],
        "name": "stakeAmount",
        "outputs": [
            {
                "internalType": "uint256",
                "name": "",
                "type": "uint256"
            }
        ],
        "stateMutability": "view",
        "type": "function"
    }
];

    let provider, signer, contract, currentAccount;

    async function log(message) {
      console.log(message);
      document.getElementById("logOutput").textContent += "\n" + message;
    }

    async function connect() {
      try {
        provider = new ethers.providers.Web3Provider(window.ethereum);
        await provider.send("eth_requestAccounts", []);
        signer = provider.getSigner();
        currentAccount = await signer.getAddress();
        contract = new ethers.Contract(contractAddress, abi, signer);
        log("Wallet connected: " + currentAccount);
        updateUI();
      } catch (err) {
        log("Connection error: " + err.message);
      }
    }

    async function updateUI() {
      const gameState = await contract.gameState();
      const p1 = await contract.player1();
      const p2 = await contract.player2();
      document.getElementById("gameState").textContent = ["WaitingForPlayer1", "WaitingForPlayer2", "CommitPhase", "RevealPhase", "Finished"][gameState];
      document.getElementById("player1").textContent = p1;
      document.getElementById("player2").textContent = p2;
      document.getElementById("winner").textContent = gameState == 4 ? "Check payouts" : "-";

      document.getElementById("joinAsPlayer1").disabled = gameState != 0;
      document.getElementById("joinAsPlayer2").disabled = gameState != 1;
      document.getElementById("commitBtn").disabled = gameState != 2;
      document.getElementById("revealBtn").disabled = gameState != 3;
      document.getElementById("resetBtn").disabled = gameState != 4;
    }

    
document.getElementById("connectBtn").onclick = async () => {
  await connect();
  await updateUI();
};


    document.getElementById("joinAsPlayer1").onclick = async () => {
      try {
        await contract.joinAsPlayer1({ value: ethers.utils.parseEther("0.02") });
        log("Joined as Player 1");
        updateUI();
      } catch (err) {
        log("Join P1 failed: " + err.reason || err.message);
      }
    };

    document.getElementById("joinAsPlayer2").onclick = async () => {
      try {
        await contract.joinAsPlayer2({ value: ethers.utils.parseEther("0.02") });
        log("Joined as Player 2");
        updateUI();
      } catch (err) {
        log("Join P2 failed: " + err.reason || err.message);
      }
    };

    document.getElementById("commitBtn").onclick = async () => {
      try {
        const move = document.getElementById("moveInput").value.toLowerCase();
        const secret = document.getElementById("secretInput").value;
        const hash = ethers.utils.keccak256(ethers.utils.toUtf8Bytes(move + secret));
        await contract.commitMove(hash);
        log("Commit move sent");
        updateUI();
      } catch (err) {
        log("Commit failed: " + err.reason || err.message);
      }
    };

    document.getElementById("revealBtn").onclick = async () => {
      try {
        const move = document.getElementById("moveInput").value.toLowerCase();
        const secret = document.getElementById("secretInput").value;
        await contract.revealMove(move, secret);
        log("Reveal move sent");
        updateUI();
      } catch (err) {
        log("Reveal failed: " + err.reason || err.message);
      }
    };

    document.getElementById("resetBtn").onclick = async () => {
      try {
        await contract.resetGame();
        log("Game reset");
        updateUI();
      } catch (err) {
        log("Reset failed: " + err.reason || err.message);
      }
    };
  </script>
</body>
</html>
